\documentclass{article}
\usepackage{lmodern}
\usepackage{ifluatex,ifdraft}
\usepackage[a6paper]{geometry}
\usepackage{parskip}
\usepackage{polyglossia}
\setmainlanguage[]{czech}
\usepackage{microtype}

\setlength{\emergencystretch}{3em}  % prevent overfull lines
\newcommand{\expl}[1]{{\sffamily #1}}

\ifluatex
\RequirePackage{luatexbase,luacode}
\begin{luacode}
  require(kpse.find_file('cstypo.lua', true))
\end{luacode}

\newcommand{\cstypoSingleLetterEnable}{%
  \luaexec{cstypo_single_letter_enable()}}
\newcommand{\cstypoSingleLetterDisable}{%
  \luaexec{cstypo_single_letter_disable()}}

\newcommand{\cstypoALetterEnable}{%
  \luaexec{cstypo_a_letter_enable()}}
\newcommand{\cstypoALetterDisable}{%
  \luaexec{cstypo_a_letter_disable()}}

\newcommand{\cstypoPercentsEnable}{%
  \luaexec{cstypo_percents_enable()}}
\newcommand{\cstypoPercentsDisable}{%
  \luaexec{cstypo_percents_disable()}}

\else
   \PackageError{This requires LuaTeX}
\fi



\begin{document}
% \directlua{
%   for i,v in pairs(node.types()) do
%   print(i,v)
%   end
%   }

\section{Bad line breaks}

\expl{The follwing text has prepostions `O' and `k' at end of line which
  is incorrect according to Czech language typography standards:}

Mezi oblíbené dětské pohádky patří pohádky \emph{O Palečkovi, Alenka v říši
  divů} a \emph{Socialismem k lepším zítřkům.}

\expl{The follwing text is the same as above but parentheses are used to test
  that a preposition stay (or not stay, in this case) with following word
  even if the prepostion is preceeded with a parenthesis:}

Mezi oblíbené dětské pohádky patří pohádky \emph{[O Palečkovi], Alenka v říši
  divů} a \emph{Socialismem (k lepším zítřkům).}

Se správným nastavením fontů znak \% v `na 100 \%' skončí na další řádce.

\section{Better line breaks}

\expl{And here we add Lua code to penalize single letter words. It results in
following line layout:}

\cstypoSingleLetterEnable{}
\cstypoPercentsEnable{}
\cstypoALetterEnable{}
Mezi oblíbené dětské pohádky patří pohádky \emph{O Palečkovi, Alenka v říši
  divů} a \emph{Socialismem k lepším zítřkům.}

\expl{The follwing text is the same as above but parentheses are used to test
  that a preposition stay with following word even if the prepostion is
  preceeded with a parenthesis:}

Mezi oblíbené dětské pohádky patří pohádky \emph{[O Palečkovi], Alenka v říši
  divů} a \emph{Socialismem (k lepším zítřkům).}

Se správným nastavením fontů znak \% v `na 100 \%' skončí na další řádce.

\cstypoSingleLetterDisable{}
\cstypoPercentsDisable{}
\cstypoALetterDisable{}


\end{document}
